"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Field = void 0;
const array_serializer_1 = require("./array-serializer");
const boolean_serializer_1 = require("./boolean-serializer");
const buffer_serializer_1 = require("./buffer-serializer");
const element_1 = require("./element");
const null_serializer_1 = require("./null-serializer");
const number_serializer_1 = require("./number-serializer");
const string_serializer_1 = require("./string-serializer");
const structure_serializer_1 = require("./structure-serializer");
function Field(...args) {
    let length = 0;
    let options = undefined;
    if (['number', 'function'].includes(typeof args[0]))
        length = args.shift();
    if (typeof args[0] === 'object')
        options = args.shift();
    if (!options)
        options = {};
    return (target, fieldName) => {
        var _a, _b, _c, _d, _e, _f, _g, _h, _j;
        let containingType = target.constructor;
        let field = {
            name: fieldName,
            containingType,
            type: Reflect.getMetadata('design:type', target, fieldName),
            length,
            options
        };
        let fieldDesc = `${containingType.name}#${String(field.name)}`;
        let BufferT = typeof Buffer !== 'undefined' ? Buffer : undefined;
        if ((field.type === BufferT || field.type === Uint8Array) && typeof field.length === 'number' && field.length % 8 !== 0)
            throw new Error(`${fieldDesc}: Length (${field.length}) must be a multiple of 8 when field type is Buffer`);
        if (field.type === Array) {
            if (!((_a = field.options.array) === null || _a === void 0 ? void 0 : _a.type))
                throw new Error(`${fieldDesc}: Array field must specify option array.type`);
            if (!(((_b = field.options.array) === null || _b === void 0 ? void 0 : _b.type.prototype) instanceof element_1.BitstreamElement) && ((_c = field.options.array) === null || _c === void 0 ? void 0 : _c.type) !== Number)
                throw new Error(`${fieldDesc}: Array fields can only be used with types which inherit from BitstreamElement`);
            if ((_d = field.options.array) === null || _d === void 0 ? void 0 : _d.countFieldLength) {
                if (typeof field.options.array.countFieldLength !== 'number' || field.options.array.countFieldLength <= 0)
                    throw new Error(`${fieldDesc}: Invalid value provided for length of count field: ${field.options.array.countFieldLength}. Must be a positive number.`);
            }
            if ((_e = field.options.array) === null || _e === void 0 ? void 0 : _e.count) {
                if (typeof field.options.array.count !== 'number' && typeof field.options.array.count !== 'function')
                    throw new Error(`${fieldDesc}: Invalid value provided for count determinant: ${field.options.array.count}. Must be a number or function`);
            }
        }
        if (field.options.readAhead) {
            if (field.options.readAhead === undefined)
                throw new Error(`${fieldDesc}: To use the readAhead option, you must specify readAhead.length`);
            if (!['number', 'function'].includes(typeof field.options.readAhead.length))
                throw new Error(`${fieldDesc}: Invalid read-ahead length specified (must be a number or discriminant function)`);
        }
        if (field.type === Number) {
            if (typeof field.length === 'number' && field.length > 53 && ((_f = field.options.number) === null || _f === void 0 ? void 0 : _f.format) !== 'float' && !((_g = field.options.number) === null || _g === void 0 ? void 0 : _g.allowOversized)) {
                throw new Error(`${fieldDesc}: It is not safe to use the 'number' type for fields larger than 53 bits. `
                    + `Consider using 'bigint' instead. `
                    + `If you are sure this is what you want, set option number.allowOversized.`);
            }
        }
        if (!options.serializer) {
            if (field.type === Array)
                options.serializer = new array_serializer_1.ArraySerializer();
            else if (((_h = field.type) === null || _h === void 0 ? void 0 : _h.prototype) instanceof element_1.BitstreamElement)
                options.serializer = new structure_serializer_1.StructureSerializer();
            else if (field.length === 0)
                options.serializer = new null_serializer_1.NullSerializer();
            else if (field.type === Object)
                options.serializer = new number_serializer_1.NumberSerializer();
            else if (field.type === Number)
                options.serializer = new number_serializer_1.NumberSerializer();
            else if (field.type === Boolean)
                options.serializer = new boolean_serializer_1.BooleanSerializer();
            else if (typeof Buffer !== 'undefined' && field.type === Buffer)
                options.serializer = new buffer_serializer_1.BufferSerializer();
            else if (field.type === Uint8Array)
                options.serializer = new buffer_serializer_1.BufferSerializer();
            else if (field.type === String)
                options.serializer = new string_serializer_1.StringSerializer();
            else
                throw new Error(`${containingType.name}#${String(field.name)}: No serializer available for type ${((_j = field.type) === null || _j === void 0 ? void 0 : _j.name) || '<unknown>'}`);
        }
        containingType.ownSyntax.push(field);
    };
}
exports.Field = Field;
//# sourceMappingURL=field.js.map