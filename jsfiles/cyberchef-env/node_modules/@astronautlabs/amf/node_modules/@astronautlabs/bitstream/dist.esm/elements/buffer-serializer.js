import { resolveLength } from "./resolve-length";
import { summarizeField } from "./utils";
/**
 * Serializes buffers to/from bitstreams
 */
export class BufferSerializer {
    *read(reader, type, parent, field) {
        let length;
        try {
            length = resolveLength(field.length, parent, field) / 8;
        }
        catch (e) {
            throw new Error(`Failed to resolve length for buffer via 'length': ${e.message}`);
        }
        let buffer;
        if (typeof Buffer !== 'undefined' && field.type === Buffer)
            buffer = Buffer.alloc(length);
        else
            buffer = new Uint8Array(length);
        let gen = reader.readBytes(buffer);
        while (true) {
            let result = gen.next();
            if (result.done === false)
                yield { remaining: result.value * 8, contextHint: () => summarizeField(field) };
            else
                break;
        }
        return buffer;
    }
    write(writer, type, parent, field, value) {
        var _a, _b, _c, _d, _e, _f;
        let length;
        try {
            length = resolveLength(field.length, parent, field) / 8;
        }
        catch (e) {
            throw new Error(`Failed to resolve length for buffer via 'length': ${e.message}`);
        }
        let fieldLength = Math.floor(length);
        let truncate = (_c = (_b = (_a = field.options) === null || _a === void 0 ? void 0 : _a.buffer) === null || _b === void 0 ? void 0 : _b.truncate) !== null && _c !== void 0 ? _c : true;
        let fill = (_f = (_e = (_d = field.options) === null || _d === void 0 ? void 0 : _d.buffer) === null || _e === void 0 ? void 0 : _e.fill) !== null && _f !== void 0 ? _f : (truncate ? 0 : false);
        if (!value) {
            throw new Error(`BufferSerializer: Field ${String(field.name)}: Cannot encode a null buffer`);
        }
        if (value.length > fieldLength) {
            if (truncate) {
                writer.writeBuffer(value.subarray(0, fieldLength));
                return;
            }
        }
        else if (value.length < fieldLength) {
            if (fill !== false) {
                let filledBuffer = new Uint8Array(fieldLength).fill(fill);
                for (let i = 0, max = value.length; i < max; ++i)
                    filledBuffer[i] = value[i];
                writer.writeBuffer(filledBuffer);
                return;
            }
        }
        writer.writeBuffer(value);
    }
}
//# sourceMappingURL=buffer-serializer.js.map